public class AdvancedMDConnector{
    //public static AdvancedMD__c authentication = AdvancedMD__c.getOrgDefaults();
    //public static AdvancedMD_List__c authentication = AdvancedMD_List__c.getAll().values()[0];
    //public static AdvancedMD_List__c authentication = AdvancedMD_List__c.getValues('Production');
    public static List<Dom.XmlNode> getAdvancedMDObject(String org, String xmlData){
        AdvancedMD_List__c authentication = AdvancedMD_List__c.getValues(org);
        if(authentication!=null){
            login(authentication);
            HttpRequest request = new HttpRequest();
            HttpResponse response = new HttpResponse();
            Http http = new Http();
            request.setTimeout(120000);
            request.setHeader('Content-Type','application/xml');
            request.setEndpoint(authentication.URL_Dynamic__c + '/xmlrpc/processrequest.asp');
            request.setBody(xmlData);
            request.setMethod('POST');     
            request.setHeader('Cookie','token=' + authentication.Token__c);
            try{
                if(!Test.isRunningTest()) response = http.send(request);
                else{
                    String xmlResponse = '';
                    if(xmlData.contains('getupdatedpatients')) xmlResponse='<PPMDResults s="PRDW2WFE0E12F2" lst="11/8/2019 2:32:35 PM"><Results servertime="2019-11-08T14:32:33.943" patientcount="17"><patientlist><patient id="57676" lastname="WELCH" firstname="BRIAN" middlename="" name="WELCH,BRIAN" chart="1348        " title="MR" address1="306" address2="855 MAIN STREET UNIT 306" zip="01801     " city="WOBURN" state="MA" officephone="                         " officeext="      " homephone="7815689409               " otherphone="7815689409               " additionalmrn="" ethnicityid="0" languageid="44" maritalstatusid="1" othertype="CELL" email="WELCHBRI@GMAIL.COM" maritalstatus="SINGLE" dob="1971-01-31T09:33:42" deceased="" sex="M" ssn="            " relationship="SELF" hipaarelationship="18" ethnicity="" language="English" races="White" ptinactivedate="" ptinactivestatuscode="" ptinactivedescription="" ptinactiveexcludedfromsearch="0" respparty="58855" rplastname="WELCH" rpfirstname="BRIAN" rpmiddlename="" rpfullname="WELCH,BRIAN" rpaddress1="306" rpaddress2="855 MAIN STREET UNIT 306" rpzipcode="01801     " rpcity="WOBURN" rpstate="MA" rpemployer="" rpaccttypecode="TA" rpaccttypedescription="TYPICAL ACCOUNT" rpofficephone="                         " rpofficeextension="      " rphomephone="7815689409               " rpotherphone="7815689409               " rpotherphonetype="CELL" rpemail="WELCHBRI@GMAIL.COM" rpdob="1971-01-31T09:33:42" rpgender="M" rpssn="            " rptitle="MR" rpemploymentstatus="1" rpcreatedat="2018-07-31T13:36:43.550" rpcreatedby="RCRECCO     " rpdisplay="1" rpchangedat="2019-11-08T05:34:55.553" rpchangedby="SGOODWIN" provider="168" profile="421" profilecode="JDIFF " profilename="DIFFILY,JARED" provlastname="DIFFILY" provfirstname="JARED" provmiddlename="" provfullname="DIFFILY,JARED" provtitle="PA" finclass="12" finclasscode="SP" finclassdescription="SELF PAY" employerid="0" employer="" insorder="" createdat="2018-07-31T13:36:43.457" changedat="2019-11-08T05:34:55.540" changedby="SGOODWIN" iccreatedat="" icchangedat="" refplanchangedat="2018-07-31T13:36:43.677" customdatachangedat="" episodechangedat="2018-07-31T13:36:43.693" updatestatus="C"><referralplanlist><referralplan id="62319" referraltype="I" defaultinchargeentry="0" byreferringproviderfid="126663" toreferringproviderfid="126663" reason="SELF-REFERRAL" preauthcode="" expirationdate="" maxcharge="0.0000" usedcharge="0.0000" maxauthvisits="0" authvisitsused="0" chargecodefid="1" statuscodefid="1" facilityfid="1" preauthorizationrequired="0" sequencenumber="1" referralplansourcefid="0" diagnosiscodes="" createdby="RCRECCO     " createdat="2018-07-28T13:36:43.457" changedby="" changedat="" byrefprovlastname="WILLIAMS" byrefprovfirstname="ELIZABETH" byrefprovmiddlename="" byrefprovfullname="WILLIAMS,ELIZABETH " byrefprovtitle="" /></referralplanlist></patient><patient id="78868" lastname="BOULET" firstname="LORNE" middlename="" name="BOULET,LORNE" chart="4616        " title="MR" address1="" address2="" zip="          " city="" state="" officephone="                         " officeext="      " homephone="                         " otherphone="6034064503               " additionalmrn="" ethnicityid="0" languageid="44" maritalstatusid="6" othertype="CELL" email="" maritalstatus="UNKNOWN" dob="1962-03-07T00:00:00" deceased="" sex="M" ssn="            " relationship="SELF" hipaarelationship="18" ethnicity="" language="English" races="" ptinactivedate="" ptinactivestatuscode="" ptinactivedescription="" ptinactiveexcludedfromsearch="0" respparty="81091" rplastname="BOULET" rpfirstname="LORNE" rpmiddlename="" rpfullname="BOULET,LORNE" rpaddress1="" rpaddress2="" rpzipcode="          " rpcity="" rpstate="" rpemployer="" rpaccttypecode="TA" rpaccttypedescription="TYPICAL ACCOUNT" rpofficephone="                         " rpofficeextension="      " rphomephone="                         " rpotherphone="6034064503               " rpotherphonetype="CELL" rpemail="" rpdob="1962-03-07T00:00:00" rpgender="M" rpssn="            " rptitle="MR" rpemploymentstatus="1" rpcreatedat="2019-11-08T12:08:00.097" rpcreatedby="SVASQUEZ    " rpdisplay="1" rpchangedat="" rpchangedby="" provider="168" profile="421" profilecode="JDIFF " profilename="DIFFILY,JARED" provlastname="DIFFILY" provfirstname="JARED" provmiddlename="" provfullname="DIFFILY,JARED" provtitle="PA" finclass="12" finclasscode="SP" finclassdescription="SELF PAY" employerid="0" employer="" insorder="" createdat="2019-11-08T12:08:00.003" changedat="" changedby="" iccreatedat="" icchangedat="" refplanchangedat="2019-11-08T12:08:00.207" customdatachangedat="" episodechangedat="2019-11-08T12:08:00.207" updatestatus="N"><referralplanlist><referralplan id="92394" referraltype="I" defaultinchargeentry="0" byreferringproviderfid="127094" toreferringproviderfid="127094" reason="SELF-REFERRAL" preauthcode="" expirationdate="" maxcharge="0.0000" usedcharge="0.0000" maxauthvisits="0" authvisitsused="0" chargecodefid="1" statuscodefid="1" facilityfid="1" preauthorizationrequired="0" sequencenumber="1" referralplansourcefid="0" diagnosiscodes="" createdby="SVASQUEZ    " createdat="2019-11-05T12:08:00.003" changedby="" changedat="" byrefprovlastname="DIFFILY" byrefprovfirstname="JARED" byrefprovmiddlename="" byrefprovfullname="DIFFILY,JARED " byrefprovtitle="P.A." /></referralplanlist></patient></patientlist></Results></PPMDResults>';
                    else if(xmlData.contains('getupdatedproviders')) xmlResponse='<PPMDResults s="PRDW2WFE052F0B" lst="11/8/2019 12:53:46 PM"><Results servertime="2019-11-08T12:53:45.540" providercount="2"><providerlist><provider id="121" lastname="WILLIAMS" firstname="ELIZABETH" middlename="" name="WILLIAMS,ELIZABETH" financialsummaryfid="218801214" accountreceivablefid="1611658389" practicefid="30" title="APRN" upinnumber="OTH000" cell="" pager="" homephone=" " email="ELIZABETH@NEMENSCLINIC.COM" changedat="2018-12-10T14:09:32.610" createuser="PPMD_STAYLOR" createdat="2018-02-12T11:59:03.047" changedby="PPMD_MMENLOV" type="" status="INACTIVE" emraccess="FULL" emractiveat="2018-02-12T00:00:00" isinstitutional="0" inactiveat="2018-12-10T14:09:32.610" inactiveby="PPMD_MMENLOV" updatestatus="C"><profilelist><profile id="249" profilecode="EWILL" license="NP 027361-23" federalid="" clianumber="" userfilefid="274013254" taxonomy="" npinumber="1023555620" billasfid="0" feeschedulefid="21092" referringproviderfid="126663" groupfid="26" statementgroupfid="27" description="WILLIAMS, ELIZABETH" facilityfid="20" xrefidschangedat="1900-01-01T00:00:00" address1="SUITE A" address2="14 KEEWAYDIN DRIVE" zipcode="03079" city="SALEM" state="NH" areacode="603" countrycode="USA" officephone="6033314640" officeextension="" fax="6033314641" changedat="2018-12-10T14:09:32.940" changedby="PPMD_MMENLOV" createuser="PPMD_STAYLOR" createdat="2018-02-12T11:59:03.153" isdefault="1" hideinchargeentry="0" providername="WILLIAMS,ELIZABETH" upinnumber="OTH000"/></profilelist></provider><provider id="168" lastname="DIFFILY" firstname="JARED" middlename="" name="DIFFILY,JARED" financialsummaryfid="218802667" accountreceivablefid="1611736452" practicefid="30" title="PA" upinnumber="OTH000" cell="" pager="" homephone=" " email="" changedat="2019-05-03T14:45:01.893" createuser="PPMD_MMENLOV" createdat="2018-12-10T14:11:24.627" changedby="PPMD_NMARTIN" type="PA" status="ACTIVE" emraccess="FULL" emractiveat="2018-12-10T00:00:00" isinstitutional="0" inactiveat="1900-01-01T00:00:00" inactiveby="" updatestatus="N"><profilelist><profile id="421" profilecode="JDIFF" license="" federalid="815252299" clianumber="" userfilefid="274014256" taxonomy="363AM0700X" npinumber="1639591183" billasfid="0" feeschedulefid="21092" referringproviderfid="127094" groupfid="26" statementgroupfid="27" description="DIFFILY,JARED" facilityfid="20" xrefidschangedat="1900-01-01T00:00:00" address1="SUITE A" address2="14 KEEWAYDIN DR" zipcode="03079-2839" city="SALEM" state="NH" areacode="603" countrycode="USA" officephone="6033314640" officeextension="" fax="6033314641" changedat="2019-05-03T14:45:02.160" changedby="PPMD_NMARTIN" createuser="PPMD_MMENLOV" createdat="2018-12-10T14:11:24.737" isdefault="1" hideinchargeentry="0" providername="DIFFILY,JARED" upinnumber="OTH000"/></profilelist></provider></providerlist></Results></PPMDResults>';
                    else if(xmlData.contains('getdemographic')) xmlResponse='<PPMDResults s="PRDW2WFE0A277D" lst="11/8/2019 3:07:38 PM"><Results><patientlist><patient id="pat57676" importid="" dob="01/31/1971" deceased="" inactive="" inactivestatus="" inactivetitle="" inactivedescription="" name="WELCH,BRIAN" respparty="resp58855" isinvoiceentity="0" profile="prof421" insorder="" sex="M" genderidentity="" genderidentityother="" orientation="" orientationother="" chart="1348" maritalstatus="1" employerid="" employer="" ssn="" finclasscode="SP" title="MR" relationship="1" hipaarelationship="18" languageid="44" ethnicityid="" language="English" ethnicity="" races="White" recalcbuckets="0" additionalmrn=""><address zip="01801" city="WOBURN" state="MA" address1="306" address2="855 MAIN STREET UNIT 306" areacode="" countrycode="" /><contactinfo name="" homephone="(781) 568-9409" officephone="" officeext="" otherphone="(781) 568-9409" othertype="C" email="WELCHBRI@GMAIL.COM" emailverificationstatus="1" preferredcommunicationfid="1" confidentialcommunicationfid="" communicationnote="" /><arbucketlist><arbucket buckettype="p" current="0.00" past30="0.00" past60="0.00" past90="0.00" past120="0.00" unapplied="0.00" total="0.00" /><arbucket buckettype="pi" current="0.00" past30="0.00" past60="0.00" past90="0.00" past120="0.00" unapplied="0.00" total="0.00" /></arbucketlist><insplanlist /><refplanlist><refplan id="rplan62319" refprov="rprov126663" type="I" refplanstatus="1" reason="SELF-REFERRAL" preauthreq="0" preauth="" refnum="" facility="fac1" proccode="" diagcodes="" begindate="07/28/2018" enddate="" maxvisits="" usedvisits="" maxamount="" usedamount="" status="status1" sequence="1" notes="" ismain="1" /></refplanlist><memolist /><filelist><file id="86082" name="ADAMS_2019-05-30" description="" filename="ADAMS_2019-05-30" filelocation="" filetype="P" fileext="" filesize="" patientid="57676" patientname="WELCH,BRIAN" patientchartnumber="1348        " profileid="421" profilecode="JDIFF " profilename="DIFFILY,JARED" visitid="199186" facilityid="" referringproviderid="" referringprovidername="" referringprovidercode="" dos="2019-05-30T12:30:00" createdby="JDIFFILY" createdat="2019-05-30T09:31:22.613" printedby="" reviewedby="JARED DIFFILY" reviewedat="" approvedby="" approvedat="" lockedby="" lockedat="" changedat="" revision="0" zipmode="0" serverfile="0" charttype="E-Form"><categorylist><category code="PTFORM" name="Patient Forms" groupcode="PTFORM" groupname="Patient Forms" filetype="P" /></categorylist><revisionlist /></file><file id="31455" name="1348-WELBR-20180815" description="1348-WELBR-20180815" filename="137669-31455-0000" filelocation="" filetype="I" fileext="PNG" filesize="3252336" patientid="57676" patientname="WELCH,BRIAN" patientchartnumber="1348" profileid="249" profilecode="EWILL" profilename="WILLIAMS, ELIZABETH" visitid="" facilityid="" referringproviderid="" referringprovidername="" referringprovidercode="" dos="2018-08-15T21:24:00" createdby="RCRECCO" createdat="2018-08-15T14:32:37.380" printedby="" printedat="" reviewedby="" reviewedat="" approvedby="" approvedat="" lockedby="" lockedat="" changedby="SYSTEM" changedat="2018-08-15T23:04:17.680" revision="0" zipmode="0" serverfile="1" charttype="Chart"><categorylist><category id="25" code="MIUNSP" name="Unspecified" groupcode="MISC" groupname="Miscellaneous" filetype="0"/></categorylist><revisionlist/></file></filelist><visitlist/><primarycareprovider/></patient></patientlist><resppartylist><respparty id="resp58855" name="WELCH,BRIAN" accttype="ac_type4" acctnum="58855" dob="01/31/1971" sex="M" title="MR" employer="" employstatus="1" ssn="" sendstmt="1" stmtrestart="" holdreasonfid="0" holdreasondesc="" holdreasoncode="" billcycle="25" fincharge="0" stmtformat="" balancefwd="1" lastpmtdate="" lastpmtamount="" laststmtdate="" laststmtamount="" lastbillingcaption="" lastbillingtip="" paymentplanbalance="" ispaperless="0" ispaperlessportalchangedate=""><address zip="01801" city="WOBURN" state="MA" address1="306" address2="855 MAIN STREET UNIT 306" areacode="" countrycode=""/><contactinfo name="" homephone="(781) 568-9409" officephone="" officeext="" otherphone="(781) 568-9409" othertype="C" email="WELCHBRI@GMAIL.COM" preferredcommunicationfid="1" communicationnote=""/><creditcardonfile/><arbucketlist><arbucket buckettype="r" current="0.00" past30="0.00" past60="0.00" past90="0.00" past120="0.00" unapplied="0.00" total="0.00"/><arbucket buckettype="ri" current="0.00" past30="0.00" past60="0.00" past90="0.00" past120="0.00" unapplied="0.00" total="0.00"/></arbucketlist><familymemberlist><familymember id="family57676" name="WELCH,BRIAN" chart="1348" isrp="1"><contactinfo homephone="(781) 568-9409"/><address zip="01801" city="WOBURN" state="MA" address1="306" address2="855 MAIN STREET UNIT 306" countrycode=""/></familymember></familymemberlist></respparty></resppartylist><accttypelist><accttype id="ac_type4" name="TYPICAL ACCOUNT" code="TA"/></accttypelist><profilelist><profile id="prof421" name="DIFFILY,JARED" fullname="DIFFILY,JARED" code="JDIFF" chargefeesched="feesch21092" fullinactive="No" status="ACTIVE"><finclasslist><finclass id="fclass1" name="" code="" billins="0" billlab="1" ca="0" responsible="0" acceptassign="0" allowablewocode="" autowo="0" autowocode="" riskwocode="" riskpercent="0"/><finclass id="fclass2" name="DOUBLE INSURANCE COVERAGE" code="DC" billins="1" billlab="1" ca="0" responsible="1" accttype="ac_type4" acceptassign="1" allowablewocode="WOINS" autowo="0" autowocode="None" riskwocode="None" riskpercent="0"/></finclasslist></profile></profilelist><carrierlist/><proccodelist/><modcodelist/><diagcodelist/><facilitylist/><statuslist /><refproviderlist><refprovider id="rprov126663" name="WILLIAMS,ELIZABETH" code="EWILL" specialty="" practicename=""><address address1="" address2="" city="" state="" zip="" areacode="603"/><contactinfo name="" homephone="" officephone="" fax="" officeext="" otherphone="" othertype="C" email="" /></refprovider></refproviderlist><notelist/></Results><Error/></PPMDResults>';
                    else if(xmlData.contains('getehrallergies')) xmlResponse='<PPMDResults s="PRDW2WFE0E12F2" lst="11/11/2019 6:29:57 AM"><Results servertime="2019-11-11T06:29:56.370" allergycount="1"><allergylist><allergy id="6" allergy="NKDA" /></allergylist></Results></PPMDResults>';
                    else if(xmlData.contains('getehrlabresults')) xmlResponse='<PPMDResults s="PRDW2WFE01CEAA" lst="11/11/2019 6:45:05 AM"><Results servertime="2019-11-11T06:45:03.703" labresultcount="3"><labresultlist><labresult id="1320" profileid="109" companyname="AMDS_Labs" obsdatetime="2019-10-31T09:58:00" specdatetime="2019-10-31T00:00:00" signby="" signat="" resultcode="RESULT_1" resultdesc="TT" resultvalue="557" resultunits="" resultrange="264-916" resultstatus="F" /><labresult id="1321" profileid="109" companyname="AMDS_Labs" obsdatetime="2019-10-31T09:58:00" specdatetime="2019-10-31T00:00:00" signby="" signat="" resultcode="RESULT_1" resultdesc="PSa" resultvalue="0.4" resultunits="" resultrange="0-4" resultstatus="F" /><labresult id="1322" profileid="109" companyname="AMDS_Labs" obsdatetime="2019-10-31T09:58:00" specdatetime="2019-10-31T00:00:00" signby="" signat="" resultcode="RESULT_1" resultdesc="E2" resultvalue="27.4" resultunits="" resultrange="7.6-42.6" resultstatus="F" /></labresultlist></Results></PPMDResults>';
                    else if(xmlData.contains('getehrnotes')) xmlResponse='<PPMDResults s="PRDW2WFE01A8C7" lst="11/11/2019 12:04:01 PM"><Results servertime="2019-11-11T12:04:01.973" patientnotecount="1"><patientnotelist><patientnote id="100024416" templatename="NewIntake Note" notedatetime="2019-09-18T13:22:00" username="MALMGREN, MICHAEL" signedbyuser="MALMGREN, MICHAEL" reviewedbyuser="" confidential="0" printedat=""><signerlist><signer id="376690" username="MALMGREN, MICHAEL" signeddat="2019-09-23T11:30:52.470"/></signerlist><pagelist><page id="541" pagename="Orders"><fieldlist><field id="32586" ordinal="32586" name="" value=""/><field id="32588" ordinal="32588" name="" value=""/><field id="32590" ordinal="32590" name="" value=""/><field id="32592" ordinal="32592" name="" value=""/><field id="32594" ordinal="32594" name="" value=""/><field id="32595" ordinal="32595" name="" value=""/><field id="32596" ordinal="32596" name="" value=""/><field id="32597" ordinal="32597" name="RMMC_QualTest1" value="169 ng/dl"/><field id="32598" ordinal="32598" name="" value=""/><field id="32599" ordinal="32599" name="RMMC_QualPSA1" value="0.75 ng/ml"/><field id="32600" ordinal="32600" name="" value=""/><field id="32601" ordinal="32601" name="rmmc_hemacue" value=""/><field id="32602" ordinal="32602" name="" value=""/><field id="32604" ordinal="32604" name="RMMC_OrderTime" value="9/18/2019 01:22 PM"/><field id="32644" ordinal="32644" name="" value=""/><field id="32708" ordinal="32708" name="RMMC_Qualnotes" value=""/><field id="32712" ordinal="32712" name="RMMC_Provider" value="Michael L. Malmgren,PA-C, MMS"/><field id="32713" ordinal="32713" name="Untitled1323" value="E29.1 Testicular Hypofunction"/><field id="32715" ordinal="32715" name="RMMC_Staff1" value="Mitchel Baldner"/><field id="32716" ordinal="32716" name="RMMC_ShipStatus" value=""/><field id="32727" ordinal="32727" name="RMMC_QualLabs" value="Qualagen Testosterone, Qualagen PSA, Full Panel TRT(Qualigen) FSH and LH, CMP, Estradiol, CBC"/><field id="32728" ordinal="32728" name="RMMC_Labsordered" value="Yes Labs were Ordered"/></fieldlist></page><page id="542" pagename="A&amp;P"><fieldlist><field id="32605" ordinal="32605" name="" value=""/><field id="32621" ordinal="32621" name="" value=""/><field id="32623" ordinal="32623" name="AP_VisitSummary" value="Discussed medication options including oral troches and TriMix. Discussed potential side effects as well as efficacy of both types of medication. Discussed mechanisms of action for each medication.&#x0A;testosterone replacement therapy&#x0A;Discussed testosterone replacement therapy in depth.  Discussed negative feedback, erythropoietic nature of the medications and the risks associated with testosterone replacement therapy in general. Emphasis placed on hematocrit and the effects of testosterone on the blood cells. "/><field id="32711" ordinal="32711" name="DX_Diagnosis" value=" F52.21 MALE ERECTILE DISORDER&#x0A; E29.1 TESTICULAR HYPOFUNCTION"/></fieldlist></page></pagelist></patientnote></patientnotelist></Results></PPMDResults>';
                    else if(xmlData.contains('getupdatedvisits')) xmlResponse='<PPMDResults s="PRDW2WFE052F0B" lst="11/11/2019 7:21:18 AM"><Results servertime="2019-11-11T07:21:16.473" visitcount="1"><visitlist><visit id="57055" visit_uid="57055" patientid="11249" columnheading="BR PROVIDER" appointmenttypeid="3366" appointmenttype="NEW INTAKE" visitstartdatetime="2019-11-12T14:00:00" visitdate="11/12/2019" visitstarttime=" 2:00PM" duration="15" color="GREEN     " profilecode="TALDMD" profilename="ALDERSON,THOMAS" profileuid="110" providername="ALDERSON,THOMAS" provideremail="thomasalderson@ymail.com" comments="" apptstatus="0" arrivetime="" othertime="" seentime="" chargesposted="1" confirmmethod="" confirmedat="" confirmedby="            " episode="STANDARD" facilitycode="BRMC " facilityname="BATON ROUGE MENS CLINIC" visitnote="" insurancebillingorder="" acceptassignment="0" forcepaperclaim="0" createdat="2019-11-11T07:00:57.330" createdby="GNEEL       " modifiedat="2019-11-11T07:00:57.330" modifiedby="GNEEL       " reftype=" " refreason="" refcreation="" refexpiration="" byrefprovcode="      " byrefprovlastname="" byrefprovfirstname="" byrefprovmiddlename="" byrefprovtitle="" byreferringproviderfid="0" updatestatus="N" istelemedicine="0"><patientlist><patient id="11249" lastname="HOLLINS" firstname="KEITH" middlename="" name="HOLLINS,KEITH" chart="373         " title="MR" address1="" address2="" zip="70809     " city="" state="" officephone="                         " officeext="      " homephone="                         " otherphone="9857053897               " additionalmrn="" ethnicityid="0" languageid="44" maritalstatusid="6" othertype="CELL" email="KHOLLINS50@YAHOO.COM" maritalstatus="UNKNOWN" dob="1959-06-03T00:00:00" deceased="" sex="M" ssn="            " relationship="SELF" hipaarelationship="18" ethnicity="" language="English" races="" ptinactivedate="" ptinactivestatuscode="" ptinactivedescription="" ptinactiveexcludedfromsearch="0" respparty="11709" rplastname="HOLLINS" rpfirstname="KEITH" rpmiddlename="" rpfullname="HOLLINS,KEITH" rpaddress1="" rpaddress2="" rpzipcode="70809     " rpcity="" rpstate="" rpemployer="" rpaccttypecode="TA" rpaccttypedescription="TYPICAL ACCOUNT" rpofficephone="                         " rpofficeextension="      " rphomephone="                         " rpotherphone="9857053897               " rpotherphonetype="CELL" rpemail="KHOLLINS50@YAHOO.COM" rpdob="1959-06-03T00:00:00" rpgender="M" rpssn="            " rptitle="MR" rpemploymentstatus="1" rpcreatedat="2019-11-11T07:00:20.860" rpcreatedby="GNEEL       " rpdisplay="1" rpchangedat="" rpchangedby="" provider="105" profile="110" profilecode="TALDMD" profilename="ALDERSON,THOMAS" provlastname="ALDERSON" provfirstname="THOMAS" provmiddlename="" provfullname="ALDERSON,THOMAS" provtitle="MD" finclass="12" finclasscode="SP" finclassdescription="SELF PAY" employerid="0" employer="" insorder="" createdat="2019-11-11T07:00:20.813" createdby="GNEEL       " changedat="" changedby="" iccreatedat="" icchangedat="" refplanchangedat="2019-11-11T07:00:20.860" customdatachangedat="" episodechangedat="2019-11-11T07:00:20.860" /></patientlist></visit></visitlist></Results></PPMDResults>';
                    else if(xmlData.contains('getdatevisits')) xmlResponse='<PPMDResults s="PRDW2WFE052F0B" lst="11/11/2019 7:21:18 AM"><Results servertime="2019-11-11T07:21:16.473" visitcount="1"><visitlist><visit id="57055" visit_uid="57055" patientid="11249" columnheading="BR PROVIDER" appointmenttypeid="3366" appointmenttype="NEW INTAKE" visitstartdatetime="2019-11-12T14:00:00" visitdate="11/12/2019" visitstarttime=" 2:00PM" duration="15" color="GREEN     " profilecode="TALDMD" profilename="ALDERSON,THOMAS" profileuid="110" providername="ALDERSON,THOMAS" provideremail="thomasalderson@ymail.com" comments="" apptstatus="0" arrivetime="" othertime="" seentime="" chargesposted="1" confirmmethod="" confirmedat="" confirmedby="            " episode="STANDARD" facilitycode="BRMC " facilityname="BATON ROUGE MENS CLINIC" visitnote="" insurancebillingorder="" acceptassignment="0" forcepaperclaim="0" createdat="2019-11-11T07:00:57.330" createdby="GNEEL       " modifiedat="2019-11-11T07:00:57.330" modifiedby="GNEEL       " reftype=" " refreason="" refcreation="" refexpiration="" byrefprovcode="      " byrefprovlastname="" byrefprovfirstname="" byrefprovmiddlename="" byrefprovtitle="" byreferringproviderfid="0" updatestatus="N" istelemedicine="0"><patientlist><patient id="11249" lastname="HOLLINS" firstname="KEITH" middlename="" name="HOLLINS,KEITH" chart="373         " title="MR" address1="" address2="" zip="70809     " city="" state="" officephone="                         " officeext="      " homephone="                         " otherphone="9857053897               " additionalmrn="" ethnicityid="0" languageid="44" maritalstatusid="6" othertype="CELL" email="KHOLLINS50@YAHOO.COM" maritalstatus="UNKNOWN" dob="1959-06-03T00:00:00" deceased="" sex="M" ssn="            " relationship="SELF" hipaarelationship="18" ethnicity="" language="English" races="" ptinactivedate="" ptinactivestatuscode="" ptinactivedescription="" ptinactiveexcludedfromsearch="0" respparty="11709" rplastname="HOLLINS" rpfirstname="KEITH" rpmiddlename="" rpfullname="HOLLINS,KEITH" rpaddress1="" rpaddress2="" rpzipcode="70809     " rpcity="" rpstate="" rpemployer="" rpaccttypecode="TA" rpaccttypedescription="TYPICAL ACCOUNT" rpofficephone="                         " rpofficeextension="      " rphomephone="                         " rpotherphone="9857053897               " rpotherphonetype="CELL" rpemail="KHOLLINS50@YAHOO.COM" rpdob="1959-06-03T00:00:00" rpgender="M" rpssn="            " rptitle="MR" rpemploymentstatus="1" rpcreatedat="2019-11-11T07:00:20.860" rpcreatedby="GNEEL       " rpdisplay="1" rpchangedat="" rpchangedby="" provider="105" profile="110" profilecode="TALDMD" profilename="ALDERSON,THOMAS" provlastname="ALDERSON" provfirstname="THOMAS" provmiddlename="" provfullname="ALDERSON,THOMAS" provtitle="MD" finclass="12" finclasscode="SP" finclassdescription="SELF PAY" employerid="0" employer="" insorder="" createdat="2019-11-11T07:00:20.813" createdby="GNEEL       " changedat="" changedby="" iccreatedat="" icchangedat="" refplanchangedat="2019-11-11T07:00:20.860" customdatachangedat="" episodechangedat="2019-11-11T07:00:20.860" /></patientlist></visit></visitlist></Results></PPMDResults>';                    
                    else if(xmlData.contains('getpatientvisits')) xmlResponse='<PPMDResults s="PRDW2WFE052F0B" lst="11/11/2019 7:21:18 AM"><Results servertime="2019-11-11T07:21:16.473" visitcount="1"><visitlist><visit id="57055" visit_uid="57055" patientid="11249" columnheading="BR PROVIDER" appointmenttypeid="3366" appointmenttype="NEW INTAKE" visitstartdatetime="2019-11-12T14:00:00" visitdate="11/12/2019" visitstarttime=" 2:00PM" duration="15" color="GREEN     " profilecode="TALDMD" profilename="ALDERSON,THOMAS" profileuid="110" providername="ALDERSON,THOMAS" provideremail="thomasalderson@ymail.com" comments="" apptstatus="0" arrivetime="" othertime="" seentime="" chargesposted="1" confirmmethod="" confirmedat="" confirmedby="            " episode="STANDARD" facilitycode="BRMC " facilityname="BATON ROUGE MENS CLINIC" visitnote="" insurancebillingorder="" acceptassignment="0" forcepaperclaim="0" createdat="2019-11-11T07:00:57.330" createdby="GNEEL       " modifiedat="2019-11-11T07:00:57.330" modifiedby="GNEEL       " reftype=" " refreason="" refcreation="" refexpiration="" byrefprovcode="      " byrefprovlastname="" byrefprovfirstname="" byrefprovmiddlename="" byrefprovtitle="" byreferringproviderfid="0" updatestatus="N" istelemedicine="0"><patientlist><patient id="11249" lastname="HOLLINS" firstname="KEITH" middlename="" name="HOLLINS,KEITH" chart="373         " title="MR" address1="" address2="" zip="70809     " city="" state="" officephone="                         " officeext="      " homephone="                         " otherphone="9857053897               " additionalmrn="" ethnicityid="0" languageid="44" maritalstatusid="6" othertype="CELL" email="KHOLLINS50@YAHOO.COM" maritalstatus="UNKNOWN" dob="1959-06-03T00:00:00" deceased="" sex="M" ssn="            " relationship="SELF" hipaarelationship="18" ethnicity="" language="English" races="" ptinactivedate="" ptinactivestatuscode="" ptinactivedescription="" ptinactiveexcludedfromsearch="0" respparty="11709" rplastname="HOLLINS" rpfirstname="KEITH" rpmiddlename="" rpfullname="HOLLINS,KEITH" rpaddress1="" rpaddress2="" rpzipcode="70809     " rpcity="" rpstate="" rpemployer="" rpaccttypecode="TA" rpaccttypedescription="TYPICAL ACCOUNT" rpofficephone="                         " rpofficeextension="      " rphomephone="                         " rpotherphone="9857053897               " rpotherphonetype="CELL" rpemail="KHOLLINS50@YAHOO.COM" rpdob="1959-06-03T00:00:00" rpgender="M" rpssn="            " rptitle="MR" rpemploymentstatus="1" rpcreatedat="2019-11-11T07:00:20.860" rpcreatedby="GNEEL       " rpdisplay="1" rpchangedat="" rpchangedby="" provider="105" profile="110" profilecode="TALDMD" profilename="ALDERSON,THOMAS" provlastname="ALDERSON" provfirstname="THOMAS" provmiddlename="" provfullname="ALDERSON,THOMAS" provtitle="MD" finclass="12" finclasscode="SP" finclassdescription="SELF PAY" employerid="0" employer="" insorder="" createdat="2019-11-11T07:00:20.813" createdby="GNEEL       " changedat="" changedby="" iccreatedat="" icchangedat="" refplanchangedat="2019-11-11T07:00:20.860" customdatachangedat="" episodechangedat="2019-11-11T07:00:20.860" /></patientlist></visit></visitlist></Results></PPMDResults>';
                    else if(xmlData.contains('gettxhistory')) xmlResponse='<PPMDResults s="PRDW2WFE052F0B" lst="11/11/2019 8:25:25 AM"><Results itemcount="0" pagecount="1" page="1" itemsfrom="0" itemsto="0" maxunfiltereddate="1900-01-01T00:00:00" oldestcharge="1900-01-01T00:00:00" newestcharge="1900-01-01T00:00:00" sumpatcharges="0.00" suminscharges="0.00" sumpatpayments="0.00" suminspayments="0.00" sumpatwriteoffs="0.00" suminswriteoffs="0.00" sumpatbal="0.00" suminsbal="0.00" totalbal="0.00" historycarriercode="1"><chargelist><charge id="102095" patientid="12345" patient="KHAN,TEA199" proccode="00104" b="0" i="1" createtime="2006-01-31T13:00:39" provcode="LARSE" provname="LARSEN,KAREN" faccode="RAD1" facname="RAD1" visit="101629" fee="39.12" paid="0.00" patbal="0.00" insbal="39.12" totbal="39.12" carrier="" resppartyid="64392" resppartyname="KHAN,TEA199" dos="01/21/2006" agingdate="01/31/2006" totalvisitcharge="39.12" paymentplan="0" void="0" protected="0" seq="20060121101629" chargeseq="20060121" approvedat="" approvedby="" isinstitutional="0"><paymentlist/><writeofflist/></charge></chargelist><unappliedpaymentlist /><unappliedwriteofflist /></Results></PPMDResults>';
                    response.setBody(xmlResponse);
                    response.setStatusCode(200);
                }
                //update authentication;
                System.debug('###AdvancedMDConnector.getAdvancedMDObject() => Response Status Code: ' + response.getStatusCode() + ', Response Body: ' + (String.isNotEmpty(response.getBody()) ? response.getBody().left(255) : ''));
                System.debug(response.getBody());
                
                /*List<Messaging.SingleEmailMessage> mails = new List<Messaging.SingleEmailMessage>();
                Messaging.SingleEmailMessage mail = New Messaging.SingleEmailMessage();
                String[] toAddress =  new String[]{'rurupeque@cloudcreations.com'};
                mail.setToAddresses(toAddress);
                mail.setSubject('Hi');
                //mail.setPlainTextBody(String.valueOf(response.getBody()).subStringBetween('<template id="100000067"','</template>'));
                //mail.setHtmlBody('<br><p>' + response.getBodyAsBlob().toString() + '--></p><br> ');
                mail.setPlainTextBody(response.getBody());
                mails.add(mail);
                Messaging.sendEmail(mails);*/
            }
            catch(Exception e){
                response = new HTTPResponse();
                response.setStatusCode(500);
                System.debug('###AdvancedMDConnector.getAdvancedMDObject - Callout Exception: ' + e.getMessage());
            }
            return response.getStatusCode() == 200 ? xmlParser(response.getBody()) : new List<Dom.XmlNode>();
        }
        else{
            System.debug('Org inválida: ' + org);
            return new List<Dom.XmlNode>();
        }
    }
    public static HTTPResponse postAdvancedMDObject(String org, String xmlData){
        AdvancedMD_List__c authentication = AdvancedMD_List__c.getValues(org);
        if(authentication!=null){
            login(authentication);
            HttpRequest request = new HttpRequest();
            HttpResponse response = new HttpResponse();
            Http http = new Http();
            request.setEndpoint(authentication.URL_Dynamic__c + '/xmlrpc/processrequest.asp');
            request.setHeader('Content-Type','application/xml');
            request.setHeader('Cookie','token=' + authentication.Token__c);
            request.setMethod('POST');     
            request.setTimeout(120000);
            request.setBody(xmlData);
            try{
                if(!Test.isRunningTest()) response = http.send(request);
                else{
                    String xmlResponse = '';
                    if(xmlData.contains('addpatient')) xmlResponse='success="1"';
                    else if(xmlData.contains('addvisit')) xmlResponse='success="1"';
                    response.setBody(xmlResponse);
                    response.setStatusCode(200);
                }
                //update authentication;
                System.debug('###AdvancedMDConnector.postAdvancedMDObject() => Response Status Code: ' + response.getStatusCode() + ', Response Body: ' + (String.isNotEmpty(response.getBody()) ? response.getBody() : ''));
            }
            catch(Exception e){
                response = new HTTPResponse();
                response.setStatusCode(500);
                response.setBody(e.getMessage());
                System.debug('###AdvancedMDConnector.postAdvancedMDObject() - Callout Exception: ' + e.getMessage());
            }
            return response;
        }
        else{
            System.debug('Org inválida: ' + org);
            HTTPResponse response = new HTTPResponse();
            response.setStatusCode(500);
            response.setBody('Org inválida: ' + org);
            return response;
        }
    }
    public static void login(AdvancedMD_List__c authentication){
        if(authentication.Token_Datetime__c == null || (DateTime.now() >= authentication.Token_Datetime__c.addHours(24).addMinutes(-1))){
            HttpRequest request = new HttpRequest();
            Http http = new Http();
            HttpResponse response = new HttpResponse();
            request.setHeader('Content-Type','application/xml');
            request.setEndpoint(authentication.URL_Login__c);
            request.setMethod('POST');        
            request.setTimeout(120000);
            String xmlData = '<ppmdmsg action="login" class="login" msgtime="'+ Datetime.now().format() +'" username="'+ authentication.Username__c +'" psw="'+ authentication.Password__c +'" officecode="'+ authentication.Office_Code__c +'" appname="'+ authentication.APP_Name__c +'"/>';
            request.setBody(xmlData);
            try{
                System.debug('1--');
                if(!Test.isRunningTest()) response = http.send(request);
                else{
                    response.setBody('<PPMDResults s="PRDW2WFE01A8C7" lst="11/8/2019 12:17:48 PM"><Results success="0"><usercontext webserver="https://provapi.advancedmd.com/processrequest/API-100/TEMP" reportingServerURL="https://reportingservices-100.advancedmd.com/rs/reportrequest.aspx" helpurl="https://ow2-help-01-prd.advancedmd.com/help/" username="SAL1004" /></Results><Error><Fault><faultcode>Client</faultcode><faultstring>Client Error</faultstring><detail><code>-2147220476</code><description>The Office Key 143755 must be redirected to https://provapi.advancedmd.com/processrequest/API-100/TEMP. When logging in to AdvancedMD, if no security token (&lt;usercontext&gt; text) is returned, then you must redirect your login to the server indicated in the "webserver" attribute of the usercontext element.</description><class>AdvancedMD.Security.Login</class><method>LoginUser</method><linenum>0</linenum><source>AdvancedMD.Security.Login</source><extrainfo /></detail></Fault></Error></PPMDResults>');
                    response.setStatusCode(200);
                }
                System.debug('1.1--');
                if(response.getStatusCode() == 200){
                    DOM.Document document = new DOM.Document();
                	System.debug('1.2--');
                    document.load(response.getBody());
                    System.debug('1.3--');
                    if(document.getRootElement().getChildElement('Results', null).getAttribute('success', null) == '0'){
                        System.debug('1.4--');
                        authentication.Token_Datetime__c = Datetime.now();
                        authentication.URL_Dynamic__c = document.getRootElement().getChildElement('Results', null).getChildElement('usercontext', null).getAttribute('webserver', null);
                        System.debug('authentication.URL_Dynamic__c: ' + authentication.URL_Dynamic__c);
                        getToken(authentication, xmlData);
                        //update authentication;
                    }
                }
            }
            catch(Exception e){
                System.debug('2--');
                if(e.getMessage().contains('Unauthorized endpoint') && MetadataAPIUtility.createRemoteSiteSettings(authentication.URL_Dynamic__c)) getToken(authentication, xmlData);
                else System.debug('###AdvancedMDConnector.login() - Callout Exception: ' + e.getMessage());
            }
        }
    }
    public static void getToken(AdvancedMD_List__c authentication, String xmlData){
        HttpRequest request = new HttpRequest();
        Http http = new Http();
        HttpResponse response = new HttpResponse();
        request.setHeader('Content-Type','application/xml');
        request.setEndpoint(authentication.URL_Dynamic__c + '/xmlrpc/processrequest.asp');
        request.setMethod('POST');
        request.setBody(xmlData);
        request.setTimeout(120000);
        try{
            if(!Test.isRunningTest()) response = http.send(request);
            else{
            	response.setBody('<PPMDResults s="PRDW2WFE0DDAB2" lst="11/8/2019 12:30:19 PM"><Results success="1" api="1" version="7.0"><usercontext reportingServerURL="https://reportingservices-100.advancedmd.com/rs/reportrequest.aspx" adhocReportingURL="https://advancedinsight.advancedmd.com" aibenchmarksurl="https://benchmarks.advancedmd.com/index.html" helpurl="https://ow2-help-01-prd.advancedmd.com/help/" webserver="https://provapi.advancedmd.com/processrequest/API-100/TEMP" username="SAL1004" email="" checkemail="1" needsconfirmation="1" sendnewconfirmation="0" pmredirecturl="https://pm-wfe-135.advancedmd.com/practicemanager" ehrredirecturl="https://webclinical-135.advancedmd.com/practicemanager" telemedicineapiurl="https://telemed.advancedmd.com/Application.Web.API" capturechallengesettings="1" scanningserverurl="https://scan.advancedmd.com/dynamsoft/Resources.15.2/Resources/" cqmssoserviceurl="https://ow2-cqmsso-01.advancedmd.com/api/account" cqmsolutionurl="https://ow2-cqm-01.advancedmd.com" portalappintakeurl="https://patientportal.advancedmd.com/143755/onlineintake" portalappolsurl="https://patientportal.advancedmd.com/143755/onlinescheduling" apptreminderapiurl="https://go.advancedmd.com/api/pe/reminders" servertimezone="Pacific Standard Time" providerid="0" defaultprofileid="0" departmentid="0" clinicaluser="0" ehronly="0" roleid="219" officecode="143755" logincode="143755" officename="Baton Rouge Mens Clinic" admin="0" adminlimited="0" edicontact="0" ssoprovidername="" twofactorenabled="0" iscbouser="0" status="A" trainingTrackerUrl="https://pm-wfe-135.advancedmd.com/AdvancedMD.TrainingTracker/">143755CfUS0MW3I47y/1n0CC7xcZZfmLa9y1yg/U5nCWsgyaS+uQHcr88Uh/Fj60HOk8jJDqT/sh2JH91pZ9PnpkLEKS2AJpQM/fT4ITzTLzOYV7TCFwZrR5PLOUOk76L0O65t5tKFz+oC9BAu+ZcoxjivdGBgKDYSlrwPM7jgIfNGgkrB80zY4D5qtiiR2M1eHQUnpjjK5s6MnFUZMurPkRmceQ==</usercontext><variation code="amdspro" name="" /></Results><Error /></PPMDResults>');
                response.setStatusCode(200);
           	}
            if(response.getStatusCode() == 200){
                DOM.Document document = new DOM.Document();
                document.load(response.getBody());
                if(document.getRootElement().getChildElement('Results', null).getAttribute('success', null) == '1'){
                    authentication.Token__c = document.getRootElement().getChildElement('Results', null).getChildElement('usercontext', null).getText();
                }
            }      
            System.debug('###AdvancedMDConnector.getToken() => Response Status Code: ' + response.getStatusCode() + ', Token: ' + authentication.Token__c);
        }
        catch(Exception e){
            if(e.getMessage().contains('Unauthorized endpoint')) throw new UnauthorizedEndpointException('Unauthorized endpoint');
            else System.debug('###AdvancedMDConnector.getToken() - Callout Exception: ' + e.getMessage());
        }
    }
    public static List<Dom.XmlNode> xmlParser(String strXml){
        Dom.Document document = new Dom.Document();
        document.load(strXml);
        if(String.isNotEmpty(strXml) && strXml.contains('<code>-2147217350</code>') && document.getRootElement().getChildElement('Results', null) != null) document.getRootElement().getChildElement('Results', null).addChildElement('code', null, null).addTextNode('-2147217350');
        List<Dom.XmlNode> childlist = document.getRootElement().getChildElement('Results', null) != null ? document.getRootElement().getChildElement('Results', null).getChildElements() : new List<Dom.XmlNode>();   
        return childlist;
    }
	public class UnauthorizedEndpointException extends Exception {}
}
