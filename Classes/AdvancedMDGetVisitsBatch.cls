global class AdvancedMDGetVisitsBatch implements Database.Batchable<Appointment__c>, Database.Stateful, Database.AllowsCallouts{
    public String org;
    public Boolean isAll;
    public Integer size;
    public Map<String, Account> updatedAccountsMap;
    public Map<String, Appointment__c> appointmentsMap;
    public Map<String, Account> accountsMap;
    public Boolean isPaginated;
    global AdvancedMDGetVisitsBatch(String org, Boolean isAll, Map<String, Account> updatedAccountsMap, Integer size){
        this(org, isAll, updatedAccountsMap, false, new Map<String, Appointment__c>(), new Map<String, Account>(), size);
    }
    global AdvancedMDGetVisitsBatch(String org, Boolean isAll, Map<String, Account> updatedAccountsMap, Boolean isPaginated, Map<String, Appointment__c> appointmentsMap, Map<String, Account> accountsMap, Integer size){
        this.org = org;
        this.isAll = isAll;
        this.updatedAccountsMap = updatedAccountsMap;
        this.isPaginated = isPaginated;
        this.appointmentsMap = appointmentsMap;
        this.accountsMap = accountsMap;
        this.size = size;
    }
    global List<Appointment__c> start(Database.BatchableContext BC){
        System.debug('Start');
        String primaryClinic = String.isNotBlank(org) ? (!org.equalsIgnoreCase('AMC') ? (!org.equalsIgnoreCase('BRMC') ? (!org.equalsIgnoreCase('CMC') ? (!org.equalsIgnoreCase('TMC') ? (!org.equalsIgnoreCase('NMC') ? (!org.equalsIgnoreCase('RMMC') ? (!org.equalsIgnoreCase('Production') ? 'Colorado Springs' : 'Rocky Mountain Mens Clinic') : 'Rocky Mountain Mens Clinic') : 'Northeast Mens Clinic') : 'Tennessee Mens Clinic') : 'Columbus Mens Clinic') : 'Baton Rouge Mens Clinic') : 'Alabama Mens Clinic')  : '' ;
        String auxPrimaryClinic='';
        if(!isPaginated){
            List<Appointment__c> appointmentsLastUpdated = [Select id, Changed_Date__c from Appointment__c where AdvancedMDID__c != null order by Changed_Date__c desc Nulls Last limit 1];
            List<Dom.XmlNode> childElements = AdvancedMDConnector.getAdvancedMDObject(org,'<ppmdmsg action="getupdatedvisits" class="api" datechanged="' + (!isAll ? (!appointmentsLastUpdated.isEmpty() ? appointmentsLastUpdated[0].Changed_Date__c.addHours(-21).format() : Datetime.now().addHours(-21).format()) : Datetime.valueOf('2010-02-01 00:00:00').format()) + '"><visit visit_uid="Visit_UID" patientid="PatientID" columnheading="ColumnHeading" appointmenttypeid="AppointmentTypeID" appointmenttype="AppointmentType" visitstartdatetime="VisitStartDateTime" visitdate="VisitDate" visitstarttime="VisitStartTime" duration="Duration" color="Color" profilecode="ProfileCode" profilename="ProfileName" profileuid="ProfileUID" providername="ProviderName" provideremail="ProviderEmail" comments="Comments" apptstatus="ApptStatus" arrivetime="ArriveTime" othertime="OtherTime" seentime="SeenTime" chargesposted="ChargesPosted" confirmmethod="ConfirmMethod" confirmedat="ConfirmedAt" confirmedby="ConfirmedBy" episode="Episode" facilitycode="FacilityCode" facilityname="FacilityName" visitnote="VisitNote" insurancebillingorder="InsuranceBillingOrder" acceptassignment="AcceptAssignment" forcepaperclaim="ForcePaperClaim" createdat="CreatedAt" createdby="CreatedBy" modifiedat="ModifiedAt" modifiedby="ModifiedBy" reftype="RefType" refreason="RefReason" refcreation="RefCreation" refexpiration="RefExpiration" byrefprovcode="ByRefProvCode" byrefprovlastname="ByRefProvLastName" byrefprovfirstname="ByRefProvFirstName" byrefprovmiddlename="ByRefProvMiddleName" byrefprovtitle="ByRefProvTitle" byreferringproviderfid="ByReferringProviderFID"/><patient lastname="LastName" firstname="FirstName" middlename="MiddleName" name="Name" chart="Chart" title="Title" address1="Address1" address2="Address2" zip="Zip" city="City" state="State" officephone="OfficePhone" officeext="OfficeExt" homephone="HomePhone" otherphone="OtherPhone" additionalmrn="AdditionalMrn" ethnicityid="EthnicityID" languageid="LanguageID" maritalstatusid="MaritalStatusID" othertype="OtherType" email="Email" maritalstatus="MaritalStatus" dob="DOB" deceased="Deceased" sex="Sex" ssn="SSN" relationship="Relationship" hipaarelationship="HIPAARelationship" ethnicity="Ethnicity" language="Language" races="Races" ptinactivedate="PtInactiveDate" ptinactivestatuscode="PtInactiveStatusCode" ptinactivedescription="PtInactiveDescription" ptinactiveexcludedfromsearch="PtInactiveExcludedFromSearch" respparty="RespParty" rplastname="RPLastName" rpfirstname="RPFirstName" rpmiddlename="RPMiddleName" rpfullname="RPFullName" rpaddress1="RPAddress1" rpaddress2="RPAddress2" rpzipcode="RPZipCode" rpcity="RPCity" rpstate="RPState" rpemployer="RPEmployer" rpaccttypecode="RPAcctTypeCode" rpaccttypedescription="RPAcctTypeDescription" rpofficephone="RPOfficePhone" rpofficeextension="RPOfficeExtension" rphomephone="RPHomePhone" rpotherphone="RPOtherPhone" rpotherphonetype="RPOtherPhoneType" rpemail="RPEmail" rpdob="RPDOB" rpgender="RPGender" rpssn="RPSSN" rptitle="RPTitle" rpemploymentstatus="RPEmploymentStatus" rpcreatedat="RPCreatedAt" rpcreatedby="RPCreatedBy" rpdisplay="RPDisplay" rpchangedat="RPChangedAt" rpchangedby="RPChangedBy" provider="Provider" profile="Profile" profilecode="ProfileCode" profilename="ProfileName" provlastname="ProvLastName" provfirstname="ProvFirstName" provmiddlename="ProvMiddleName" provfullname="ProvFullName" provtitle="ProvTitle" finclass="FinClass" finclasscode="FinClassCode" finclassdescription="FinClassDescription" employerid="EmployerID" employer="Employer" insorder="InsOrder" createdat="CreatedAt" createdby="CreatedBy" changedat="ChangedAt" changedby="ChangedBy" iccreatedat="ICCreatedAt" icchangedat="ICChangedAt" refplanchangedat="RefPlanChangedAt" customdatachangedat="CustomDataChangedAt" episodechangedat="EpisodeChangedAt"/></ppmdmsg>');
            isPaginated = childElements.size() > 1 && childElements[1].getText() == '-2147217350';
            System.debug('A: ' + childElements.size());
            for(Dom.XmlNode childElement1:childElements){
                System.debug('B: ' + childElement1.getChildElements().size());
                for(Dom.XmlNode childElement2:childElement1.getChildElements()){
                    if(String.isNotBlank(childElement2.getAttributeValue('id', ''))) appointmentsMap.put(org.touppercase() + '-' + childElement2.getAttributeValue('id', ''), new Appointment__c(
                        AdvancedMDID__c = org.touppercase() + '-' + childElement2.getAttributeValue('id', ''),
                        Patient_Id__c = childElement2.getChildElement('patientlist', null) != null && !childElement2.getChildElement('patientlist', null).getChildElements().isEmpty() ? org.touppercase() + '-' + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', '') : '',
                        Provider_Code__c = String.isNotBlank(childElement2.getAttributeValue('profilecode', '')) ? childElement2.getAttributeValue('profilecode', '').trim() : '',
                        Name = String.isNotBlank(childElement2.getAttributeValue('visit_uid', '')) ? childElement2.getAttributeValue('visit_uid', '') : childElement2.getAttributeValue('id', ''),
                        Visit_Number__c = childElement2.getAttributeValue('visit_uid', ''),
                        Created_Date__c = String.isNotBlank(childElement2.getAttributeValue('createdat', '')) ? DateTime.valueOf(childElement2.getAttributeValue('createdat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Changed_Date__c = String.isNotBlank(childElement2.getAttributeValue('modifiedat', '')) ? DateTime.valueOf(childElement2.getAttributeValue('modifiedat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Appointment_Type__c = childElement2.getAttributeValue('appointmenttype', ''),
                        Appointment_Status__c = childElement2.getAttributeValue('apptstatus', '') == '0' ? 'Made' : childElement2.getAttributeValue('apptstatus', '') == '1' ? 'Arrived' : childElement2.getAttributeValue('apptstatus', '') == '2' ? 'Other' : childElement2.getAttributeValue('apptstatus', '') == '3' ? 'Complete' : childElement2.getAttributeValue('apptstatus', '') == '5' ? 'Moved' : childElement2.getAttributeValue('apptstatus', '') == '12' ? 'No Show' : childElement2.getAttributeValue('apptstatus', '') == '10' ? 'Cancelled' : childElement2.getAttributeValue('apptstatus', '') == '11' ? 'Deleted' : childElement2.getAttributeValue('apptstatus', ''),
                        Provider_Room__c = childElement2.getAttributeValue('columnheading', ''),
                        Start_Date_time__c = String.isNotBlank(childElement2.getAttributeValue('visitstartdatetime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('visitstartdatetime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        End_date_Time__c = String.isNotBlank(childElement2.getAttributeValue('visitstartdatetime', '')) && String.isNotBlank(childElement2.getAttributeValue('duration', '')) ? DateTime.valueOf(childElement2.getAttributeValue('visitstartdatetime', '').substringBeforeLast('.').replace('T', ' ')).addMinutes(Integer.valueOf(childElement2.getAttributeValue('duration', ''))) : null,                    
                        Episode__c = childElement2.getAttributeValue('episode', ''),
                        Appointment_Color__c = childElement2.getAttributeValue('color', ''),
                        Confirmed_Method__c = childElement2.getAttributeValue('confirmmethod', '') == '11' ? 'Auto Confirmed' : childElement2.getAttributeValue('confirmmethod', '') == '4' ? 'Email' : childElement2.getAttributeValue('confirmmethod', '') == '3' ? 'Fax Sent' : childElement2.getAttributeValue('confirmmethod', '') == '5' ? 'Letter Sent' : childElement2.getAttributeValue('confirmmethod', '') == '6' ? 'Left a message' : childElement2.getAttributeValue('confirmmethod', '') == '9' ? 'Phoned-No Answer-No voice mail' : childElement2.getAttributeValue('confirmmethod', '') == '2' ? 'Phone Call' : childElement2.getAttributeValue('confirmmethod', '') == '8' ? 'Spoke with Person' : childElement2.getAttributeValue('confirmmethod', '') == '7' ? 'Spoke with Patient' : childElement2.getAttributeValue('confirmmethod', ''),
                        Arrive_Time__c = String.isNotBlank(childElement2.getAttributeValue('arrivetime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('arrivetime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Other_Time__c = String.isNotBlank(childElement2.getAttributeValue('othertime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('othertime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Seen_Time__c = String.isNotBlank(childElement2.getAttributeValue('seentime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('seentime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Confirmed_At__c = String.isNotBlank(childElement2.getAttributeValue('confirmedat', '')) ? DateTime.valueOf(childElement2.getAttributeValue('confirmedat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Confirmed_By__c = childElement2.getAttributeValue('confirmedby', ''),
                        Comments__c = childElement2.getAttributeValue('comments', ''),
                        Visit_Note__c = childElement2.getAttributeValue('visitnote', ''),
                        Accepts_Assignment__c = childElement2.getAttributeValue('acceptassignment', ''),
                        Referred_Type__c = childElement2.getAttributeValue('reftype', ''),
                        Referred_Reason__c = childElement2.getAttributeValue('refreason', ''),
                        Referring_Provider_Code__c = String.isNotBlank(childElement2.getAttributeValue('byrefprovcode', '')) ? childElement2.getAttributeValue('byrefprovcode', '').trim() : '',
                    	Facility__c = (String.isNotBlank(childElement2.getAttributeValue('facilitycode', '')) ? childElement2.getAttributeValue('facilitycode', '').trim() + ' ' : '') + (String.isNotBlank(childElement2.getAttributeValue('facilityname', '')) ? childElement2.getAttributeValue('facilityname', '').trim() : '')
                    ));
                    auxPrimaryClinic = org.equalsIgnoreCase('RMMC') || org.equalsIgnoreCase('NMC') ? String.isNotBlank(childElement2.getAttributeValue('facilitycode', '')) ? childElement2.getAttributeValue('facilitycode', '').trim() : '' : '';
                    if(childElement2.getChildElement('patientlist', null) != null && !childElement2.getChildElement('patientlist', null).getChildElements().isEmpty() && String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', ''))) accountsMap.put(org.touppercase() + '-' + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', ''), new Account(
                        RecordTypeId = Schema.SObjectType.Account.getRecordTypeInfosByName().get('Patient') != null ? Schema.SObjectType.Account.getRecordTypeInfosByName().get('Patient').getRecordTypeId() : null,
                        AdvancedMDID__c = org.touppercase() + '-' + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', ''),
                        Primary_Clinic__c = String.isNotBlank(auxPrimaryClinic) ? auxPrimaryClinic.equalsIgnoreCase('COS') ? 'Colorado Springs' :  auxPrimaryClinic.equalsIgnoreCase('DEN') ? 'Central Denver' :  auxPrimaryClinic.equalsIgnoreCase('NOCO') ? 'North Denver' :  auxPrimaryClinic.equalsIgnoreCase('CROCK') ? 'Castle Rock' : auxPrimaryClinic.equalsIgnoreCase('NEMH2') ? 'Northeast Mens Clinic - Dedham' : primaryClinic   : primaryClinic,
                        Provider_Id__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('provider', ''),
                        FirstName = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('firstname', ''),
                        MiddleName = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('middlename', ''),
                        LastName = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('lastname', '')) ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('lastname', '') : '',
                        Created_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('createdat', '')) ? DateTime.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('createdat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Changed_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('changedat', '')) ? DateTime.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('changedat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Chart_Number__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('chart', ''),
                        PersonTitle = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('title', ''),
                        BillingStreet = (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address1', '')) ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address1', '') : '') + (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address2', '')) ? (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address1', '')) ? ', ' : '') + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address2', '') : ''),
                        BillingCity = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('city', ''),
                        BillingState = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('state', ''),
                        BillingPostalCode = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('zip', ''),
                        PersonHomePhone = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('homephone', ''),
                        Work_Phone__c = (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officephone', '')) ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officephone', '') : '') + (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officeext', '')) ? (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officephone', '')) ? ' - ' : '') + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officeext', '') : ''),
                        PersonMobilePhone = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('othertype', '') == 'CELL' ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('otherphone', '') : '',
                        Fax = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('othertype', '') == 'FAX' ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('otherphone', '') : '',
                        PersonOtherphone = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('othertype', '') == 'OTHER' ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('otherphone', '') : '',
                        PersonEmail = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('email', ''),
                        Patient_Status__c = String.isBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('deceased', '')) ? 'Active' : 'Deceased',
                        Patient_Inactivate_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ptinactivedate', '')) ? Date.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ptinactivedate', '').substringBefore('T')) : null,
                        Patient_Inactivate_Description__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ptinactivedescription', ''),
                        As_of_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('deceased', '')) ? Date.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('deceased', '').substringBefore('T')) : null,
                        PersonBirthdate = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('dob', '')) ? Date.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('dob', '').substringBefore('T')) : null,
                        Sex__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', '') == 'M' ? 'Male' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', '') == 'F' ? 'Female' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', '') == 'U' ? 'Unknown' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', ''),
                        SSN__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ssn', ''),
                        Additional_MRN__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('additionalmrn', ''),
                        Relationship__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '18' ? '18-Self' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '01' ? '01-Spouse' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '04' ? '04-Grandfather or Grandmother' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '05' ? '05-Grandson or Granddaughter' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '07' ? '07-Nephew or Niece' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '09' ? '09-Adopted Child' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '10' ? '10-Foster Child' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '15' ? '15-Ward' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '17' ? '17-Stepson or Stepdaughter' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '19' ? '19-Child' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '20' ? '20-Employee' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '21' ? '21-Unknown' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '22' ? '22-Handicapped Dependent' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '23' ? '23-Sponsored Dependent' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '24' ? '24-Dependent of a Minor Dependent' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '29' ? '29-Significant Other' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '32' ? '32-Mother' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '33' ? '33-Father' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '34' ? '34-Other Adult' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '36' ? '36-Emancipated Minor' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '39' ? '39-Organ Donor' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '40' ? '40-Cadaver Donor' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '41' ? '41-Injured Plaintiff' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '43' ? '43-Child Where Insured Has No Financial Responsibility' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '53' ? '53-Life Partner' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == 'G8' ? 'G8-Other Relationship' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', ''),
                        Preferred_Language__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('language', ''),
                        Employer__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('employer', ''),
                        Race__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('races', ''),
                        Ethnicity__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ethnicity', '')
                    ));
                } 
            }
            //if(AdvancedMDConnector.authentication.Token_Datetime__c == null || (DateTime.now() >= AdvancedMDConnector.authentication.Token_Datetime__c.addHours(24).addMinutes(-1))){AdvancedMDConnector.authentication.Token_Datetime__c = Datetime.now();update AdvancedMDConnector.authentication;}
        }
        if(isPaginated){
            List<Appointment__c> appointments = new List<Appointment__c>();
            Integer i = 1;
            for(Appointment__c appointment:appointmentsMap.values()){if(i > size){break;}appointments.add(appointment);i++;}
            return appointments;
        }
        return appointmentsMap.values();
    }
    global void execute(Database.BatchableContext BC, List<Appointment__c> scope){
        String primaryClinic = String.isNotBlank(org) ? (!org.equalsIgnoreCase('AMC') ? (!org.equalsIgnoreCase('BRMC') ? (!org.equalsIgnoreCase('CMC') ? (!org.equalsIgnoreCase('CMC2') ? (!org.equalsIgnoreCase('NMC') ? (!org.equalsIgnoreCase('RMMC') ? (!org.equalsIgnoreCase('Production') ? 'Colorado Springs' : 'Rocky Mountain Mens Clinic') : 'Rocky Mountain Mens Clinic') : 'Northeast Mens Clinic') : 'Columbus Mens Clinic') : 'Columbus Mens Clinic') : 'Baton Rouge Mens Clinic') : 'Alabama Mens Clinic')  : '';
        String auxPrimaryClinic='';
        Map<String, Appointment__c> appointmentsScopeMap = new Map<String, Appointment__c>();
        Map<String, Account> accountsScopeMap = new Map<String, Account>();
        Map<String, Contact> contactsMap = new Map<String, Contact>();
        if(isPaginated){
            Appointment__c appointment;
            String visitsXml, xmlData = '';
            for(Appointment__c appmnt:scope){visitsXml += '<visit id="' + ApexUtil.getAMDID(appmnt.AdvancedMDID__c, org) + '"/>';appointmentsMap.remove(appmnt.AdvancedMDID__c);}
            xmlData = '<ppmdmsg action="getupdatedvisits" class="api"><visitlist>' + visitsXml + '</visitlist><visit visit_uid="Visit_UID" patientid="PatientID" columnheading="ColumnHeading" appointmenttypeid="AppointmentTypeID" appointmenttype="AppointmentType" visitstartdatetime="VisitStartDateTime" visitdate="VisitDate" visitstarttime="VisitStartTime" duration="Duration" color="Color" profilecode="ProfileCode" profilename="ProfileName" profileuid="ProfileUID" providername="ProviderName" provideremail="ProviderEmail" comments="Comments" apptstatus="ApptStatus" arrivetime="ArriveTime" othertime="OtherTime" seentime="SeenTime" chargesposted="ChargesPosted" confirmmethod="ConfirmMethod" confirmedat="ConfirmedAt" confirmedby="ConfirmedBy" episode="Episode" facilitycode="FacilityCode" facilityname="FacilityName" visitnote="VisitNote" insurancebillingorder="InsuranceBillingOrder" acceptassignment="AcceptAssignment" forcepaperclaim="ForcePaperClaim" createdat="CreatedAt" createdby="CreatedBy" modifiedat="ModifiedAt" modifiedby="ModifiedBy" reftype="RefType" refreason="RefReason" refcreation="RefCreation" refexpiration="RefExpiration" byrefprovcode="ByRefProvCode" byrefprovlastname="ByRefProvLastName" byrefprovfirstname="ByRefProvFirstName" byrefprovmiddlename="ByRefProvMiddleName" byrefprovtitle="ByRefProvTitle" byreferringproviderfid="ByReferringProviderFID"/><patient lastname="LastName" firstname="FirstName" middlename="MiddleName" name="Name" chart="Chart" title="Title" address1="Address1" address2="Address2" zip="Zip" city="City" state="State" officephone="OfficePhone" officeext="OfficeExt" homephone="HomePhone" otherphone="OtherPhone" additionalmrn="AdditionalMrn" ethnicityid="EthnicityID" languageid="LanguageID" maritalstatusid="MaritalStatusID" othertype="OtherType" email="Email" maritalstatus="MaritalStatus" dob="DOB" deceased="Deceased" sex="Sex" ssn="SSN" relationship="Relationship" hipaarelationship="HIPAARelationship" ethnicity="Ethnicity" language="Language" races="Races" ptinactivedate="PtInactiveDate" ptinactivestatuscode="PtInactiveStatusCode" ptinactivedescription="PtInactiveDescription" ptinactiveexcludedfromsearch="PtInactiveExcludedFromSearch" respparty="RespParty" rplastname="RPLastName" rpfirstname="RPFirstName" rpmiddlename="RPMiddleName" rpfullname="RPFullName" rpaddress1="RPAddress1" rpaddress2="RPAddress2" rpzipcode="RPZipCode" rpcity="RPCity" rpstate="RPState" rpemployer="RPEmployer" rpaccttypecode="RPAcctTypeCode" rpaccttypedescription="RPAcctTypeDescription" rpofficephone="RPOfficePhone" rpofficeextension="RPOfficeExtension" rphomephone="RPHomePhone" rpotherphone="RPOtherPhone" rpotherphonetype="RPOtherPhoneType" rpemail="RPEmail" rpdob="RPDOB" rpgender="RPGender" rpssn="RPSSN" rptitle="RPTitle" rpemploymentstatus="RPEmploymentStatus" rpcreatedat="RPCreatedAt" rpcreatedby="RPCreatedBy" rpdisplay="RPDisplay" rpchangedat="RPChangedAt" rpchangedby="RPChangedBy" provider="Provider" profile="Profile" profilecode="ProfileCode" profilename="ProfileName" provlastname="ProvLastName" provfirstname="ProvFirstName" provmiddlename="ProvMiddleName" provfullname="ProvFullName" provtitle="ProvTitle" finclass="FinClass" finclasscode="FinClassCode" finclassdescription="FinClassDescription" employerid="EmployerID" employer="Employer" insorder="InsOrder" createdat="CreatedAt" createdby="CreatedBy" changedat="ChangedAt" changedby="ChangedBy" iccreatedat="ICCreatedAt" icchangedat="ICChangedAt" refplanchangedat="RefPlanChangedAt" customdatachangedat="CustomDataChangedAt" episodechangedat="EpisodeChangedAt"/></ppmdmsg>';
            for(Dom.XmlNode childElement1:AdvancedMDConnector.getAdvancedMDObject(org, xmlData)){
                for(Dom.XmlNode childElement2:childElement1.getChildElements()){
                    if(String.isNotBlank(childElement2.getAttributeValue('id', ''))) appointmentsScopeMap.put(org.touppercase() + '-' + childElement2.getAttributeValue('id', ''), new Appointment__c(
                        AdvancedMDID__c = org.touppercase() + '-' + childElement2.getAttributeValue('id', ''),
                        Patient_Id__c = childElement2.getChildElement('patientlist', null) != null && !childElement2.getChildElement('patientlist', null).getChildElements().isEmpty() ? org.touppercase() + '-' + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', '') : '',
                        Provider_Code__c = String.isNotBlank(childElement2.getAttributeValue('profilecode', '')) ? childElement2.getAttributeValue('profilecode', '').trim() : '',
                        Name = String.isNotBlank(childElement2.getAttributeValue('visit_uid', '')) ? childElement2.getAttributeValue('visit_uid', '') : childElement2.getAttributeValue('id', ''),
                        Visit_Number__c = childElement2.getAttributeValue('visit_uid', ''),
                        Created_Date__c = String.isNotBlank(childElement2.getAttributeValue('createdat', '')) ? DateTime.valueOf(childElement2.getAttributeValue('createdat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Changed_Date__c = String.isNotBlank(childElement2.getAttributeValue('modifiedat', '')) ? DateTime.valueOf(childElement2.getAttributeValue('modifiedat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Appointment_Type__c = childElement2.getAttributeValue('appointmenttype', ''),
                        Appointment_Status__c = childElement2.getAttributeValue('apptstatus', '') == '0' ? 'Made' : childElement2.getAttributeValue('apptstatus', '') == '1' ? 'Arrived' : childElement2.getAttributeValue('apptstatus', '') == '2' ? 'Other' : childElement2.getAttributeValue('apptstatus', '') == '3' ? 'Complete' : childElement2.getAttributeValue('apptstatus', '') == '5' ? 'Moved' : childElement2.getAttributeValue('apptstatus', '') == '12' ? 'No Show' : childElement2.getAttributeValue('apptstatus', '') == '10' ? 'Cancelled' : childElement2.getAttributeValue('apptstatus', '') == '11' ? 'Deleted' : childElement2.getAttributeValue('apptstatus', ''),
                        Provider_Room__c = childElement2.getAttributeValue('columnheading', ''),
                        Start_Date_time__c = String.isNotBlank(childElement2.getAttributeValue('visitstartdatetime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('visitstartdatetime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        End_date_Time__c = String.isNotBlank(childElement2.getAttributeValue('visitstartdatetime', '')) && String.isNotBlank(childElement2.getAttributeValue('duration', '')) ? DateTime.valueOf(childElement2.getAttributeValue('visitstartdatetime', '').substringBeforeLast('.').replace('T', ' ')).addMinutes(Integer.valueOf(childElement2.getAttributeValue('duration', ''))) : null,                    
                        Episode__c = childElement2.getAttributeValue('episode', ''),
                        Appointment_Color__c = childElement2.getAttributeValue('color', ''),
                        Confirmed_Method__c = childElement2.getAttributeValue('confirmmethod', '') == '11' ? 'Auto Confirmed' : childElement2.getAttributeValue('confirmmethod', '') == '4' ? 'Email' : childElement2.getAttributeValue('confirmmethod', '') == '3' ? 'Fax Sent' : childElement2.getAttributeValue('confirmmethod', '') == '5' ? 'Letter Sent' : childElement2.getAttributeValue('confirmmethod', '') == '6' ? 'Left a message' : childElement2.getAttributeValue('confirmmethod', '') == '9' ? 'Phoned-No Answer-No voice mail' : childElement2.getAttributeValue('confirmmethod', '') == '2' ? 'Phone Call' : childElement2.getAttributeValue('confirmmethod', '') == '8' ? 'Spoke with Person' : childElement2.getAttributeValue('confirmmethod', '') == '7' ? 'Spoke with Patient' : childElement2.getAttributeValue('confirmmethod', ''),
                        Arrive_Time__c = String.isNotBlank(childElement2.getAttributeValue('arrivetime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('arrivetime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Other_Time__c = String.isNotBlank(childElement2.getAttributeValue('othertime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('othertime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Seen_Time__c = String.isNotBlank(childElement2.getAttributeValue('seentime', '')) ? DateTime.valueOf(childElement2.getAttributeValue('seentime', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Confirmed_At__c = String.isNotBlank(childElement2.getAttributeValue('confirmedat', '')) ? DateTime.valueOf(childElement2.getAttributeValue('confirmedat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Confirmed_By__c = childElement2.getAttributeValue('confirmedby', ''),
                        Comments__c = childElement2.getAttributeValue('comments', ''),
                        Visit_Note__c = childElement2.getAttributeValue('visitnote', ''),
                        Accepts_Assignment__c = childElement2.getAttributeValue('acceptassignment', ''),
                        Referred_Type__c = childElement2.getAttributeValue('reftype', ''),
                        Referred_Reason__c = childElement2.getAttributeValue('refreason', ''),
                        Referring_Provider_Code__c = String.isNotBlank(childElement2.getAttributeValue('byrefprovcode', '')) ? childElement2.getAttributeValue('byrefprovcode', '').trim() : '',
                        Facility__c = (String.isNotBlank(childElement2.getAttributeValue('facilitycode', '')) ? childElement2.getAttributeValue('facilitycode', '').trim() + ' ' : '') + (String.isNotBlank(childElement2.getAttributeValue('facilityname', '')) ? childElement2.getAttributeValue('facilityname', '').trim() : '')
                    ));
                    auxPrimaryClinic = org.equalsIgnoreCase('RMMC') || org.equalsIgnoreCase('NMC')  ? String.isNotBlank(childElement2.getAttributeValue('facilitycode', '')) ? childElement2.getAttributeValue('facilitycode', '').trim() : '' : '';
                    if(childElement2.getChildElement('patientlist', null) != null && !childElement2.getChildElement('patientlist', null).getChildElements().isEmpty() && String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', '')) /*&& accountsMap.get(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', '')) == null*/) accountsMap.put(org.touppercase() + '-' + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', ''), new Account(
                        RecordTypeId = Schema.SObjectType.Account.getRecordTypeInfosByName().get('Patient') != null ? Schema.SObjectType.Account.getRecordTypeInfosByName().get('Patient').getRecordTypeId() : null,
                        AdvancedMDID__c = org.touppercase() + '-' + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('id', ''),
                        Primary_Clinic__c = String.isNotBlank(auxPrimaryClinic) ? auxPrimaryClinic.equalsIgnoreCase('COS') ? 'Colorado Springs' :  auxPrimaryClinic.equalsIgnoreCase('DEN') ? 'Central Denver' :  auxPrimaryClinic.equalsIgnoreCase('NOCO') ? 'North Denver' :  auxPrimaryClinic.equalsIgnoreCase('CROCK') ? 'Castle Rock' : auxPrimaryClinic.equalsIgnoreCase('NEMH2') ? 'Northeast Mens Clinic - Dedham' : primaryClinic   : primaryClinic,
                        Provider_Id__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('provider', ''),
                        FirstName = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('firstname', ''),
                        MiddleName = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('middlename', ''),
                        LastName = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('lastname', '')) ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('lastname', '') : '',
                        Created_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('createdat', '')) ? DateTime.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('createdat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Changed_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('changedat', '')) ? DateTime.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('changedat', '').substringBeforeLast('.').replace('T', ' ')) : null,                    
                        Chart_Number__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('chart', ''),
                        PersonTitle = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('title', ''),
                        BillingStreet = (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address1', '')) ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address1', '') : '') + (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address2', '')) ? (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address1', '')) ? ', ' : '') + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('address2', '') : ''),
                        BillingCity = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('city', ''),
                        BillingState = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('state', ''),
                        BillingPostalCode = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('zip', ''),
                        PersonHomePhone = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('homephone', ''),
                        Work_Phone__c = (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officephone', '')) ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officephone', '') : '') + (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officeext', '')) ? (String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officephone', '')) ? ' - ' : '') + childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('officeext', '') : ''),
                        PersonMobilePhone = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('othertype', '') == 'CELL' ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('otherphone', '') : '',
                        Fax = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('othertype', '') == 'FAX' ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('otherphone', '') : '',
                        PersonOtherphone = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('othertype', '') == 'OTHER' ? childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('otherphone', '') : '',
                        PersonEmail = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('email', ''),
                        Patient_Status__c = String.isBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('deceased', '')) ? 'Active' : 'Deceased',
                        Patient_Inactivate_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ptinactivedate', '')) ? Date.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ptinactivedate', '').substringBefore('T')) : null,
                        Patient_Inactivate_Description__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ptinactivedescription', ''),
                        As_of_Date__c = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('deceased', '')) ? Date.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('deceased', '').substringBefore('T')) : null,
                        PersonBirthdate = String.isNotBlank(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('dob', '')) ? Date.valueOf(childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('dob', '').substringBefore('T')) : null,
                        Sex__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', '') == 'M' ? 'Male' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', '') == 'F' ? 'Female' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', '') == 'U' ? 'Unknown' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('sex', ''),
                        SSN__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ssn', ''),
                        Additional_MRN__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('additionalmrn', ''),
                        Relationship__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '18' ? '18-Self' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '01' ? '01-Spouse' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '04' ? '04-Grandfather or Grandmother' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '05' ? '05-Grandson or Granddaughter' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '07' ? '07-Nephew or Niece' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '09' ? '09-Adopted Child' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '10' ? '10-Foster Child' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '15' ? '15-Ward' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '17' ? '17-Stepson or Stepdaughter' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '19' ? '19-Child' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '20' ? '20-Employee' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '21' ? '21-Unknown' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '22' ? '22-Handicapped Dependent' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '23' ? '23-Sponsored Dependent' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '24' ? '24-Dependent of a Minor Dependent' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '29' ? '29-Significant Other' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '32' ? '32-Mother' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '33' ? '33-Father' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '34' ? '34-Other Adult' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '36' ? '36-Emancipated Minor' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '39' ? '39-Organ Donor' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '40' ? '40-Cadaver Donor' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '41' ? '41-Injured Plaintiff' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '43' ? '43-Child Where Insured Has No Financial Responsibility' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == '53' ? '53-Life Partner' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', '') == 'G8' ? 'G8-Other Relationship' : childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('hipaarelationship', ''),
                        Preferred_Language__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('language', ''),
                        Employer__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('employer', ''),
                        Race__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('races', ''),
                        Ethnicity__c = childElement2.getChildElement('patientlist', null).getChildElements()[0].getAttributeValue('ethnicity', '')
                    ));
                }                 
            } 
        } 
        else for(Appointment__c appmnt:scope) appointmentsScopeMap.put(appmnt.AdvancedMDID__c, appmnt);
        for(Appointment__c appmnt:appointmentsScopeMap.values()){
            if(String.isNotBlank(appmnt.Patient_Id__c) && accountsMap.get(appmnt.Patient_Id__c) != null && String.isEmpty(accountsMap.get(appmnt.Patient_Id__c).id)) accountsScopeMap.put(appmnt.Patient_Id__c, accountsMap.get(appmnt.Patient_Id__c));
            if(String.isNotBlank(appmnt.Provider_Code__c)) contactsMap.put(appmnt.Provider_Code__c, new Contact());
            if(String.isNotBlank(appmnt.Referring_Provider_Code__c)) contactsMap.put(appmnt.Referring_Provider_Code__c, new Contact());
        }
        List<Account> accountsToInsert=new List<Account>();
        for(Account account:[Select id, AdvancedMDID__c from Account where AdvancedMDID__c in :accountsScopeMap.keySet()]) accountsScopeMap.get(account.AdvancedMDID__c).id = account.id;
        for(Account account:accountsScopeMap.values()) if(String.isEmpty(account.id)) accountsToInsert.add(account);
        List<Database.UpsertResult> upsertResults;
        /*if(!accountsToInsert.isEmpty()){*/
            ApexUtil.isAdvancedMDAccountTriggerInvoked = true;
            upsertResults = Database.upsert(accountsScopeMap.values(), Account.AdvancedMDID__c, false);
            for(Database.UpsertResult upsertResult:upsertResults) if(!upsertResult.isSuccess()) for(Database.Error upsertError : upsertResult.getErrors()) System.debug('AdvancedMDGetVisitsBatch - Account Upsert Error: ' + upsertError.getMessage());
        /*}*/
        for(Contact contact:[Select id, Code__c from Contact where Code__c in :contactsMap.keySet()]) contactsMap.get(contact.Code__c).id = contact.id;
        for(Appointment__c appmnt:appointmentsScopeMap.values()){
            if(accountsMap.get(appmnt.Patient_Id__c) != null) appmnt.Patient__c = accountsMap.get(appmnt.Patient_Id__c).id;
            if(contactsMap.get(appmnt.Provider_Code__c) != null) appmnt.Provider__c = contactsMap.get(appmnt.Provider_Code__c).id;
            if(contactsMap.get(appmnt.Referring_Provider_Code__c) != null) appmnt.Provider_Referral__c = contactsMap.get(appmnt.Referring_Provider_Code__c).id;
        }
        if(!appointmentsScopeMap.values().isEmpty()){
            ApexUtil.isAppointmentTriggerInvoked = true;
            upsertResults = Database.upsert(appointmentsScopeMap.values(), Appointment__c.AdvancedMDID__c, false);
            for(Database.UpsertResult upsertResult:upsertResults) if(!upsertResult.isSuccess()) for(Database.Error upsertError : upsertResult.getErrors()) System.debug('AdvancedMDGetVisitsBatch - Appointment__c Upsert Error: ' + upsertError.getMessage());
        }
        //if(AdvancedMDConnector.authentication.Token_Datetime__c == null || (DateTime.now() >= AdvancedMDConnector.authentication.Token_Datetime__c.addHours(24).addMinutes(-1))){AdvancedMDConnector.authentication.Token_Datetime__c = Datetime.now();update AdvancedMDConnector.authentication;}
    }
    global void finish(Database.BatchableContext BC){
        if(!Test.isRunningTest()){
    		if(isPaginated && !appointmentsMap.values().isEmpty()) System.scheduleBatch(new AdvancedMDGetVisitsBatch(org, isAll, updatedAccountsMap, true, appointmentsMap, accountsMap, size), 'AdvancedMDGetVisitsBatch-' + org, 1, 200);    
    		else if(isPaginated || !appointmentsMap.values().isEmpty() || !accountsMap.values().isEmpty()) System.scheduleBatch(new AdvancedMDPostPatientsBatch(org), 'AdvancedMDPostPatientsBatch-' + org, 1, 200); 
    		else Database.executeBatch(new AdvancedMDPostPatientsBatch(org));   
        }
    }
}